#!/usr/bin/env bash

REPO_DIR=${REPO_DIR:-"$HOME/Repositories"}
cd $REPO_DIR
repos=(
  fout/fout
  fout/fout_logs
  fout/fout_infra
  fout/fout_fm
  fout/fout_ui
  fout/fout_hubot
  fout/fout_webhook
  fout/fout_analysis
  fout/fout_ukigumo
  doiken/fout_sandbox
  doiken/cpp_test
  doiken/perl
)
for r in ${repos[@]}; do
    git clone "git@github.com:${r}.git"
done

##
## App
##
brew cask install trailer

##
## for fout perl
##
brew install plenv
# brew install perl-build broken for now
# https://qiita.com/narita_cpp/items/03e55b9acf4b3fbed99c
git clone git://github.com/tokuhirom/Perl-Build.git ~/.plenv/plugins/perl-build/

cd $REPO_DIR/fout

# build 5.24.3 ~> carton install
# http://tweeeety.hateblo.jp/entry/2015/06/21/203144
plenv install 5.24.3
plenv local 5.24.3
plenv install-cpanm
plenv exec cpanm Module::Install
plenv exec cpanm Carton
plenv exec carton install

# for fout box
vagrant box add http://downloads.fout.local/vagrant/localdev-c7
vagrant box add http://downloads.fout.local/vagrant/localdev

# hammerspoon
cat >~/.hammerspoon/Spoons/fo_attendance.lua <<EOL
spoon.SpoonInstall:andUse("FoAttendance", {
  repo = 'doiken',
  loglevel = "info",
  fn = function (self)
    -- keep variable not to gabage collect timer
    self._originalStop = spoon.FoAttendance.stop
    spoon.FoAttendance.stop = function (self)
      self:_originalStop(self)
      -- 実行時にPCが停止状態(週末など)だとintervalが向こうとなるため、
      -- autoStopAtAttend 発火時にtimerを埋め込むように変更
      self._timer = hs.timer.doAt("19:00", "1d", function () spoon.FoAttendance:start() end)
    end
    spoon.FoAttendance:stop()
  end
})
EOL
